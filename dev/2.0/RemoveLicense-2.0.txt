#Remove Office 365 License from Students and Employees
#August 14 2015
#Michael Matthews
##################
#This script removes licenses from those who are not eligable for those licenses.  However this does not remove 
#the actual account.  It only removes the licenses. 
#the password for any "person" user is "W3ar33dgy!"
#####################

#Formatting Data
$todaysDate = Get-Date -Format yyyy-%M-%d
$date = (Get-Date).AddDays(-1)
$yesterdaysDate = date $date -format yyyy-%M-%d

#Establishing a session
Import-Module MSOnline
$securePassword = ConvertTo-SecureString "W3ar33dgy!" -AsPlainText -Force
$credentials = New-Object System.Management.Automation.PSCredential("mjm287@byucommtest.onmicrosoft.com", $securePassword)
Connect-MsolService -Credential $credentials

$needtoremovelist = import-csv D:\Stage\CurrentUsers.stage\userstodelete-$todaysdate.txt

$needtoremove = @()

ForEach($old in $needtoremovelist) {
    ($needtoremove += $old.UserPrincipalName)
}

$catch2 = 20

#This is the email that would be sent out in case of a failure
$From = "michaeljmatthews@byu.edu"
$To = "comms_admins@byu.edu"
$Cc = "michaeljmatthews22@gmail.com"
$Subject = "TEST"
$Body = "THIS IS A TEST - SCRIPT FAILED.  You have tried to remove the following individuals from their license usage

$needtoremovelist

If this is the desired number of people to remove, you will need to rerun this script. And change the variable of catch3 so
This function of the script is in place to try and ensure that mass numbers of users are removed on accident "

$SMTPServer = "gateway.byu.edu"
$SMTPPort = "25"

$Subject2 = "You have restored licenses that were expired."
$Body2 = "The number of licenses dropped signficatly.  If you were really trying to remove the following users
please contact the lead engineer to do this:

$needtoremove


Perhaps the license order changed or more licenses were added to Office 365.  In that case the script needs to be modified
So that the giveback function works correctly.Thank you for your consideration.

BYU Office of OIT
$todaysDate" 


#This serves as a douple check.  If $needtoremove exceeds a certain number the script will stop
if ($needtoremove.length -ge $catch2) 
{
Write-host "You are trying to remove too many users at once.  This script will not function correctly"
Send-MailMessage -From $From -to $To -Cc $Cc -Subject $Subject -Body $Body -SmtpServer $SMTPServer -port $SMTPPort -UseSsl 
break
}


$needtoremove |  ForEach-Object {
    $csvusers += $_.UserPrincipalName;
    $usersFound = Get-MsolUser -UserPrincipalName $_.UserPrincipalName;
    
    if ($usersFound -ne $null) {
        if($usersFound.isLicensed) {

            if ($_.Status -eq "Student"){
                Set-MsolUser -UserPrincipalName $_.UserPrincipalName -UsageLocation "US"
	            Set-MsolUserLicense -UserPrincipalName $_.UserPrincipalName -LicenseOptions @($student, $studentadvantage, $BI) -RemoveLicenses @("byu:STANDARDWOFFPACK_STUDENT", "byu:OFFICESUBSCRIPTION_STUDENT", "byu:POWER_BI_STANDARD");
               Write-Output "Removed existing user $($_.UserPrincipalName) from Student" >> "D:\Scripts\Licensesupdates\Logs\ChangeLogs\change-$curDate.txt";
            }
            elseif ($_.Status -eq "Employee"){
                Set-MsolUser -UserPrincipalName $_.UserPrincipalName -UsageLocation "US"
                Set-MsolUserLicense -UserPrincipalName $_.UserPrincipalName -LicenseOptions @($faculty, $facultyadvantage, $BI) -RemoveLicenses @("byu:STANDARDWOFFPACK_FACULTY", "byu:OFFICESUBSCRIPTION_FACULTY", "byu:POWER_BI_STANDARD");
                Write-Output "Removed existing user $($_.UserPrincipalName) from Faculty" >> "D:\Scripts\Licensesupdates\Logs\ChangeLogs\change-$curDate.txt";
            }

        }
    
 }
 } 

$needtoremove >> D:/stage/changelogs/removed-$todaysDate.txt