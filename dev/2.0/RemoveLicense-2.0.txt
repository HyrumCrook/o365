#In order to make this script better, I could make it so that it doesn't output the processing information on line 21

#This script removes licenses from those who are not eligable for those licenses.  However this does not remove 
#the actual account.  It only removes the licenses. 
#the password for any "person" user is "W3ar33dgy!"


#########This script is different in that it depends on just recieving a single text file of all users to delete
#instead of needing to compare a list with another one. 

$todaysDate = Get-Date -Format yyyy-%M-%d
$date = (Get-Date).AddDays(-1)
$yesterdaysDate = date $date -format yyyy-%M-%d
Import-Module MSOnline
$securePassword = ConvertTo-SecureString "W3ar33dgy!" -AsPlainText -Force
$credentials = New-Object System.Management.Automation.PSCredential("mjm287@byucommtest.onmicrosoft.com", $securePassword)
Connect-MsolService -Credential $credentials

$needtoremovelist = import-csv D:\Stage\CurrentUsers.stage\userstodelete-$todaysdate.txt

$needtoremove = @()

ForEach($old in $needtoremovelist) {
    ($needtoremove += $old.UserPrincipalName)
}

$catch2 = 35

#This is the email that would be sent out in case of a failure
$From = "michaeljmatthews@byu.edu"
$To = "office365admin@byu.edu"
$Cc = "michaeljmatthews22@gmail.com"
$Subject = "TEST"
$Body = "THIS IS A TEST - SCRIPT FAILED.  You have tried to remove the following individuals from their license usage

$needtoremovelist

If this is the desired number of people to remove, you will need to rerun this script. And change the variable of catch3 so
This function of the script is in place to try and ensure that mass numbers of users are removed on accident "

$SMTPServer = "gateway.byu.edu"
$SMTPPort = "25"

$Subject2 = "You have restored licenses that were expired."
$Body2 = "The number of licenses dropped signficatly.  If you were really trying to remove the following users
please contact the lead engineer to do this:

$needtoremove


Perhaps the license order changed or more licenses were added to Office 365.  In that case the script needs to be modified
So that the giveback function works correctly.Thank you for your consideration.

BYU Office of OIT
$todaysDate" 


#This serves as a douple check.  If $needtoremove exceeds a certain number the script will stop
if ($needtoremove.length -ge $catch2) 
{
Write-host "You are trying to remove too many users at once.  This script will not function correctly"
Send-MailMessage -From $From -to $To -Cc $Cc -Subject $Subject -Body $Body -SmtpServer $SMTPServer -port $SMTPPort -UseSsl 
break
}

#This does the actual removal of the licenses
for($i = 0; $i -lt $needtoremove.Length; $i++) {
    Set-MsolUserLicense -UserPrincipalName $needtoremove[$i] -RemoveLicenses byucommtest:EXCHANGESTANDARD_ALUMNI
} 

$needtoremove >> D:/stage/changelogs/removed-$todaysDate.txt