#Give O365 Licenses
#August 14, 2015
#Michael Matthews 
#################
#This script is designed to give office 365 licenses to students and employees at BYU.  It logs in using the Connet-MsolService command
#It then sets forth the different types of licenses. Afterwards it uses the Import-CSV command to bring in the list of need-to-add users.
#Afterwards it determines whether or not they are a student or employee.  They are then given the appriopriate licenses.  
#This information is then logged under D:\Scripts\Licensesupdates\Logs\ChangeLogs
#################

#if it misses a day the next day it'll theoritcally check

#Formatting Dates
$todaysDate = Get-Date -Format yyyy-%M-%d
$currentYear = Get-Date -Format yyyy

#Establishing a session.  In the Dev environment this is different than the prod information
Import-Module MSOnline
$securePassword = ConvertTo-SecureString "W3ar33dgy!" -AsPlainText -Force
$credentials = New-Object System.Management.Automation.PSCredential("mjm287@byucommtest.onmicrosoft.com", $securePassword)
Connect-MsolService -Credential $credentials

#The variables below are for logging purposes
$fileToWrite = "D:\Scripts\Licensesupdates\Logs\ChangeLogs\$currentYear\change-$todaysDate.txt" 
$toLogStudent = " Added the following students "
$toLogEmployee = " Added the following employees"
$noUsers = "No Users were added today"

#In dev the licenses are different than those in prod
$student = New-MsolLicenseOptions -AccountSkuId byucommtest:STANDARDWOFFPACK_FACULTY  -DisabledPlans EXCHANGE_S_STANDARD,MCOSTANDARD

$faculty = New-MsolLicenseOptions -AccountSkuId byucommtest:STANDARDWOFFPACK_FACULTY -DisabledPlans EXCHANGE_S_STANDARD,MCOSTANDARD

#This list is supplied by the Informatica feed daily.  If this script fails to update the users one day, the next they will still be considered "new"
$needtogivelist = import-csv D:\Stage\CurrentUsers.stage\userstodelete.txt

$needtogivelist |  ForEach-Object {
    $usersFound = Get-MsolUser -UserPrincipalName $_.UserPrincipalName;
    
    if ($usersFound -ne $null) {
        if(!($usersFound.isLicensed)) {

            if ($_.Status -eq "Student"){
              Set-MsolUser -UserPrincipalName $_.UserPrincipalName -UsageLocation "US"
              #The line below is the the code that actually gives the license
              Set-MsolUserLicense -UserPrincipalName $_.UserPrincipalName -LicenseOptions @($student) -AddLicenses @("byucommtest:STANDARDWOFFPACK_FACULTY");
              $toLogStudent += "$($_.UserPrincipalName)", "$($_.Status)";
            }
            elseif ($_.Status -eq "Employee"){
               Set-MsolUser -UserPrincipalName $_.UserPrincipalName -UsageLocation "US"
                #The line below is the the code that actually gives the license
               Set-MsolUserLicense -UserPrincipalName $_.UserPrincipalName -LicenseOptions @($faculty) -AddLicenses @("byucommtest:STANDARDWOFFPACK_FACULTY");
              $toLogEmployee += "$($_.UserPrincipalName)", "$($_.Status)";
            }

        }
    
     }
 } 
 
 #If there isn't any users added then it loggs $noUsers
 
 if ($needtogivelist.Length -eq 0){

 $noUsers | Outfile $fileToWrite -append

 }
 else {
 
 $toWriteStudent | Out-file $fileToWrite -append
 $toWriteEmployee | Out-File $fileToWrite -append

 }